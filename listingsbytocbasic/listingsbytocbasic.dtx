% \iffalse meta-comment
% ======================================================================
% listingsbytocbasic.dtx
% Copyright © 2008–2023 Markus Kohm
%
% This work is a KOMA-Script spin-off.  For the original sources of
% KOMA-Script's `listings.hak' see file `scrhack.dtx' in the KOMA-Script
% sources at <https://sourceforge.net/p/koma-script/code/>.
%
% Development is taking place as part of `scrhack' at
% <https://github.com/komascript/third-party-enhancements>.  New issues
% should be reported there as well as known issues can be found.
%
% This work may be distributed and/or modified under the conditions of
% the LaTeX Project Public License, version 1.3c of the license.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.<3c or later is part of all distributions of LaTeX
% version 2005/12/01 or later and of this work.
%
% This work has the LPPL maintenance status "author-maintained".
%
% The Current Maintainer and author of this work is Markus Kohm.
%
% This work consists of the file `listingsbytocbasic.dtx' and
% `README.md'.
%
% The recommended way to install `listingsbytocbasic' is to use
% the package manager of your TeX distribution.
% ======================================================================
%
%<*dtx>
\ifx\ProvidesFile\undefined\def\ProvidesFile#1[#2]{}\fi
\ProvidesFile{listingsbytocbasic.dtx}
%</dtx>
%<*dtx|package>
%<package>\ProvidesPackage{listingsbytocbasic}
             [2023-07-14 v0.1
%<dtx>              sources and unpack driver of
              improved listings package using tocbasic]
%</dtx|package>
%<*dtx>
\ifx\documentclass\undefined
  \input docstrip.tex
  \generate{%
    \file{listingsbytocbasic.sty}{%
      \from{listingsbytocbasic.dtx}{package}%
    }%
  }%
\else
  \let\endbatchfile\relax
\fi
\endbatchfile
\documentclass[ngerman,USenglish]{koma-script-source-doc}
\setlength\IndexMin{7\baselineskip}
\usepackage{babel}
\usepackage{csquotes}
\usepackage[style=alphabetic]{biblatex}
\begin{filecontents}[force]{\jobname.bib}
@online{pkg:float,
  author={Anselm Lingnau},
  title={\pkg*{float} --- Improved interface for floating objects},
  version={1.3d},
  date={2001-11-08},
  url={https://ctan.org/pkg/float},
  urldate={2023-07-14},
  note={Improves the interface for defining floating objects such as figures
        and tables. Introduces the boxed float, the ruled float and the
        plaintop float. You can define your own floats and improve the
        behaviour of the old ones.},
}
@manual{pkg:float:manual,
  author={Anselm Lingnau},
  date={2001-11-08},
  title={An Improved Environment for Floats},
  url={http://mirrors.ctan.org/macros/latex/contrib/float/float.pdf},
  urldate={2023-07-14},
  abstract={This style option improves the interface for defining floating
            objects such as figures and tables in \LaTeX. It adds the notion
            of a ‘float style’ that governs appearance of floats. New kinds of
            floats may be defined using \cs{newfloat} command analogous to
            \cs{newtheorem}. This style option also incorporates the
            functionality of David Carlisle’s style option \pkg{here}, giving
            floating environments a \texttt{[H]} option which means ‘PUT IT
            HERE’ (as opposed to the standard \texttt{[h]} option which means
            ‘You may put it here if you like’).},
}
@online{pkg:listings,
  author  = {Jobst Hoffmann and Carsten Heinz and Brooks Moses},
  title   = {\pkg*{listings} --- Typeset source code listings using \LaTeX},
  version = {1.9},
  date    = {2023-02-23},
  url     = {https://www.ctan.org/pkg/listings},
  urldate = {2023-07-19},
  note    = {The package enables the user to typeset programs (programming
             code) within \LaTeX{}; the source code is read directly by
             \TeX---no front-end processor is needed. Keywords, comments and
             strings can be typeset using different styles (default is bold
             for keywords, italic for comments and no special style for
             strings). Support for \pkg{hyperref} is provided.},
}
@manual{pkg:listings:manual,
  author   = {Jobst Hoffmann and Carsten Heinz and Brooks Moses},
  title    = {The \pkg*{Listings} Package},
  version  = {1.9},
  date     = {2023-02-27},
  url      = {http://mirrors.ctan.org/macros/latex/contrib/listings/listings.pdf},
  urldate  = {2023-07-19},
  anstract = {The listings package is a source code printer for \LaTeX. You
              can typeset stand alone files as well as listings with an
              environment similar to \env{verbatim} as well as you can print
              code snippets using a command similar to \cs{verb}. Many
              parameters control the output and if your preferred programming
              language isn’t already supported, you can make your own
              definition.},
}
@online{pkg:xpatch,
  author   = {Enrico Gregorio},
  version  = {0.3},
  date     = {2020-03-25},
  title    = {\pkg*{xpatch} – Extending \pkg{etoolbox} patching commands},
  url      = {https://ctan.org/pkg/xpatch},
  urldate  = {2023-07-19},
  note     = {The package generalises the macro patching commands provided
              by Philipp Lehmann's \pkg{etoolbox}.},
}
@manual{pkg:xpatch:manual,
  author   = {Enrico Gregorio},
  version  = {0.3},
  date     = {2020-03-25},
  title    = {The \pkg*{xpatch} package
              extending \pkg{etoolbox} patching commands},
  url      = {http://mirrors.ctan.org/macros/latex/contrib/xpatch/xpatch.pdf},
  urldate  = {2023-07-19},
  abstract = {},
}
@online{pkg:koma-script,
  author={Markus Kohm},
  version={3.41},
  date={2023-07-07},
  title={{\KOMAScript} --- A bundle of versatile classes and packages},
  url={https://ctan.org/pkg/koma-script},
  urldate={2023-07-14},
  note={The \KOMAScript{} bundle provides replacements for the \pkg*{article},
        \pkg*{report}, and \pkg*{book} classes with emphasis on typography and
        versatility. There is also a letter class.},
}
@online{pkg:tocbasic,
  author={Markus Kohm},
  version={3.41},
  date={2023-07-07},
  title={\pkg*{tocbasic} --- Management of tables/lists of contents (and the
         like)},
  url={https://ctan.org/pkg/tocbasic},
  urldate={2023-07-14},
  note={The package provides means to create specialised ``table of
        contents''-like lists of features of a document.},
}
@manual{pkg:koma-script:manual:de,
  author={Markus Kohm},
  date={2023-06-16},
  title={{\KOMAScript}},
  subtitle={Die Anleitung},
  url={http://mirrors.ctan.org/macros/latex/contrib/koma-script/scrguide-de.pdf},
  urldate={2023-07-04},
}
@manual{pkg:koma-script:manual:en,
  author={Markus Kohm},
  date={2023-06-16},
  title={{\KOMAScript}},
  subtitle={The Guide},
  url={http://mirrors.ctan.org/macros/latex/contrib/koma-script/scrguide-en.pdf},
  urldate={2023-07-14},
}
\end{filecontents}
\errorcontextlines=\maxdimen
\addbibresource{\jobname.bib}
\setcounter{StandardModuleDepth}{2}
\begin{document}
  \nocite{pkg:float,pkg:listings,pkg:koma-script,pkg:tocbasic}
  \DocInput{listingsbytocbasic.dtx}
\end{document}
%</dtx>
%\fi
%
% \changes{v0.1}{2023/06/01}{start of \KOMAScript{} spin-off}
%
% \GetFileInfo{listingsbytocbasic.dtx}
% \title{Improving ``\pkg{listings}'' Using
%  \href{https://komascript.de/}{\KOMAScript} Package ``\pkg{tocbasic}''}
% \author{\href{mailto:komascript@gmx.info}{Markus Kohm}}
% \date{Version \filedate{} \fileversion}
% \maketitle
% \begin{abstract}
%   Package \pkg*{listingsbytocbasic} has started as hack module of the
%   \KOMAScript{} package \pkg*{scrhack} years ago to fix an issue when using
%   package \pkg{listings} with \KOMAScript~3.  This became necessary because
%   package \pkg{listings} still depends on an interface once proposed by the
%   \KOMAScript{} author, but which has long since failed to meet
%   requirements. Unfortunately, this problem could not be solved in dialog
%   with the author of \pkg{listings}. Although \pkg*{listingsbytocbasic} still
%   loads the \pkg{listings} package, it then changes some internal commands to
%   use and optimally support the \KOMAScript{} package \pkg{tocbasic}. On the
%   one hand, the user interface of \pkg{listings} remains usable unchanged,
%   but at the same time the package benefits from many possibilities of
%   \pkg{tocbasic}.
% \end{abstract}
%
% \tableofcontents
%
%\iffalse
%<*doc>
%\fi
\section{Why should I use this package instead of
  \texorpdfstring{\pkg{float}}{float} only if I use a \KOMAScript{} class or
  \KOMAScript{} package \texorpdfstring{\pkg{tocbasic}}{tocbasic}?}
\label{sec:whywithkomascript}

The main symptom of using a deprecated interface to \KOMAScript{} by package
\pkg{float}, namely the use of \cs{float@listhead} and
\cs{float@addtolists}, are corresponding warnings when using one of the
\KOMAScript{} classes at the same time, for example:
\begin{verbatim}
  Class scrbook Warning: \float@addtolists detected!
  (scrbook)              Implementation of \float@addtolist became
  (scrbook)              deprecated in KOMA-Script v3.01 2008/11/14 and
  (scrbook)              has been replaced by several more flexible
  (scrbook)              features of package `tocbasic`.
  (scrbook)              Since Version 3.12 support for deprecated
  (scrbook)              \float@addtolist interface has been
  (scrbook)              restricted to only some of the KOMA-Script
  (scrbook)              features and been removed from others.
  (scrbook)              Loading of package `scrhack' may help to
  (scrbook)              avoid this warning, if you are using a
  (scrbook)              a package that still implements the
  (scrbook)              deprecated \float@addtolist interface.
\end{verbatim}
or
\begin{verbatim}
  Class scrbook Warning: \float@listhead detected!
  (scrbook)              Implementation of \float@listhead became
  (scrbook)              deprecated in KOMA-Script v3.01 2008/11/14 and
  (scrbook)              has been replaced by several more flexible
  (scrbook)              features of package `tocbasic`.
  (scrbook)              Maybe implementation of \float@listhead will
  (scrbook)              removed from KOMA-Script soon.
  (scrbook)              Loading of package `scrhack' may help to
  (scrbook)              avoid this warning, if you are using a
  (scrbook)              a package that still implements the
  (scrbook)              deprecated \float@listhead interface.
\end{verbatim}

If you know, that the issue is because of loading package \pkg{listings} you
can avoid it using \pkg{listingsbytocbasic} as explained in
\autoref{sec:howtouse}.

\section{Why should I use this package instead of
  \texorpdfstring{\pkg{listings}}{listings} only if I don't use a
  \KOMAScript{} class or package?}
\label{sec:whywithoutkomascript}

Package \pkg{listings} does not check if a file extension already has been
defined when the package is loaded. So several definitions of environments the
same file extension could happen by accident. Package
\pkg*{listingsbytocbasic} adds test to detect such issues.

Package \pkg{tocbasic} provides several additional features, e.g.:
\begin{itemize}
\item automatic handling of language switching using \pkg{babel},
\item optional numbered heading for a list/table of contents like the list of
  listings,
\item optional adding an entry to the table of contents for a list/table of
  contents like the list of listings even if the heading of the list is not
  numbered,
\item easy configuration of entries to a list/table of contents like the list
  of listings.
\end{itemize}
Several more features can be added by the class or other packages. See section
about \pkg*{tocbasic} in the \KOMAScript{} manual, either
\autocite{pkg:koma-script:manual:en} or \autocite{pkg:koma-script:manual:de}.

\section{How to use \texorpdfstring{\pkg*{listingsbytocbasic}}{listingsbytocbasic}}
\label{sec:howtouse}

In the document preamble of your document you just can replace
\begin{verbatim}
  \usepackage{listings}
\end{verbatim}
by
\begin{verbatim}
  \usepackage{listingsbytocbasic}
\end{verbatim}
to load package \pkg*{listingsbytocbasic}. This does still also load package
\pkg{listings} but additionally patches several commands of \pkg{listings} to
avoid the issues shown in \autoref{sec:whywithkomascript}.

If you want you can alternatively also load both packages explicitly, either
\pkg{listings} before \pkg{listingsbytocbasic} or---if you
want---\pkg{listingsbytocbasic} before \pkg{listings}. This is also useful, if
you use a package, that uses \pkg*{listings} itself. In this case, you always
should load \pkg{listingsbytocbasic} \emph{before} the package, that uses
\pkg{listings}. Otherwise it is very likely that for some new float
environments the enhancements of \pkg*{listingsbytocbasic} will not be used.

When using a class that uses \pkg{listings}, the correct operation can be
ensured with
\begin{verbatim}
  \AddToHook{package/listings/after}{\RequirePackage{listingsbytocbasic}}
\end{verbatim}
even before \cs{documentclass}. This requires at least \LaTeX{}
2020/10/01. For older versions of \LaTeX{} you can use
\begin{verbatim}
  \RequirePackage{scrlfile}
  \AfterPackage{listings}{\RequirePackage{listingsbytocbasic}}
\end{verbatim}
also before \cs{documentclass}. This would require the \KOMAScript{} package
\pkg{scrlfile}\nocite{pkg:scrlfile}.

The user interface of \pkg*{listingsbytocbasic} is the same as of
\pkg{listings}, see \autocite{pkg:listings:manual}. Following we document only
the differences. But you will automatically benefit from all the features of
\pkg{tocbasic}. See the \pkg{tocbasic} chapter in the \KOMAScript{} manuals,
either \autocite{pkg:koma-script:manual:en} or
\autocite{pkg:koma-script:manual:de} for more information.

\begin{description}
\item[Note:] \pkg*{listingsbytocbasic} uses owner/category \texttt{float} for
  file extension \file{lol} used by \pkg{listings}. This means, that, e.g.,
  features configured for this owner by the \KOMAScript{} classes will be used
  automatically for the list of listings.
\end{description}
%
% \iffalse
%</doc>
% \fi
%
% \MaybeStop{\printbibliography[heading=bibintoc]\PrintIndex}
%
% \iffalse
%<*package>
% \fi
% \section{Implementation}
%
% \pkg{listingsbytocbasic} depend on \KOMAScript{} package \pkg{tocbasic}. So we
% load it already before everything else. We use this package also to require
% at least \KOMAScript{} 3.41, which is one version before the intended
% spin-off.
%    \begin{macrocode}
\RequirePackage{tocbasic}[2023/07/07]
%    \end{macrocode}
%
% We also load package \pkg{listings}, because we reuse most of the code:
%    \begin{macrocode}
\RequirePackage{listings}
%    \end{macrocode}
%
% As often as possible, we do not redefine macors of \pkg{listings}, but patch
% them using \pkg{xpatch}\nocite{pkg:xpatch}:
%    \begin{macrocode}
\RequirePackage{xpatch}
%    \end{macrocode}
%
% We register the file extension. \pkg{tocbasic} should report already
% registered file extension:
%    \begin{macrocode}
\addtotoclist[float]{lol}
%    \end{macrocode}
% \begin{description}
% \item[Note:] We do not need to setup feature \texttt{chapteratlist}, because
%   classes like the \KOMAScript{} classes should use
%\begin{verbatim}
%  \AtAddToTocList[float]{\setuptoc{\@currext}{chapteratlist}}
%\end{verbatim}
%   to implement such features.
% \end{description}
%
% \begin{command}{\lstlistoflistings}
% This command is redefined using a complete new definition using
% \pkg{tocbasic}'s \cs{listoftoc}.
%    \begin{macrocode}
\renewcommand*{\lstlistoflistings}{\listoftoc[{\lstlistlistingname}]{lol}}%
%    \end{macrocode}
% \end{command}
%
% \begin{macro}{\ext@lstlisting,\lst@MakeCaption}
% Usually \pkg{listings} does not define \cs{ext@lstlisting}, but this would
% make it impossible to use another file extension, e.g., for a separate list
% of listings of the appendix. So we define, if needed:
%    \begin{macrocode}
\providecommand*{\ext@lstlisting}{lol}%
%    \end{macrocode}
% and also patch the usage into \cs{lst@MakeCaption}
%    \begin{macrocode}
\xpatchcmd\lst@MakeCaption
  {\addcontentsline{lol}}%
  {\addcontentsline{\ext@lstlisting}}%
  {\PackageInfo{listingsbytocbasic}{patching \string\lst@MakeCaption}\@tempswatrue}%
  {\PackageError{listingsbytocbasic}{incompatible definition of
      \string\lst@MakeCaption}{%
      Package `listingsbytocbasic' depends on the original definition of
      package\MessageBreak
      `listings'.\MessageBreak
      Some changes to that definition are tolerated.\MessageBreak
      \@ifundefined{lst@MakeCaption}%
      {But it seems the definition is completely missing!}%
      {But the current definition is incompatible!}%
      \MessageBreak
      Make sure, you have installed the original package `listings'\Messagebreak
      as referred by section ``References'' of the manual.%
    }%
  }%
\@whilesw\if@tempswa\fi{%
  \xpatchcmd\lst@MakeCaption
    {\addcontentsline{lol}}%
    {\addcontentsline{\ext@lstlisting}}%
    {}%
    {\@tempswafalse}%
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\lst@makecaption}
% Usually \pkg{listings} does not setup \cs{@captype} in
% \cs{lst@makecaption}. We change this (using a patch). This adds support for
% usage of \cs{raggedlstlistingcaption} (if the user or a package author
% defines it). We again use a patch to avoid problem, if \pkg{listings} would
% add an argument to \cs{lst@makecaption}.
%    \begin{macrocode}
\xpretocmd\lst@makecaption{%
  \PackageInfo{listingsbytocbasic}{patching \string\lst@makecaption}
  \def\@captype{lstlisting}%
}{}{%
  \PackageError{listingsbytocbasic}{incompatible definition of
    \string\lst@makesaption}{%
    Package `listingsbytocbasic' depends on the original definition of
    package\MessageBreak
    `listings'.\MessageBreak
    Some changes to that definition are tolerated.\MessageBreak
    \@ifundefined{lst@makecaption}%
    {But it seems the definition is completely missing!}%
    {But the current definition is incompatible!}%
    \MessageBreak
    Make sure, you have installed the original package `listings'\Messagebreak
    as referred by section ``References'' of the manual.%
  }%
}
%    \end{macrocode}
% \end{macro}
%
% \iffalse
%</package>
% \fi
%
% \Finale
% \PrintChanges
%  
% \endinput
% Local Variables:
% mode: doctex
% ispell-local-dictionary: "en_US"
% eval: (flyspell-mode 1)
% TeX-master: t
% End:
